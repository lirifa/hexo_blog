---
title: js中的闭包
date: 2021-02-06 15:39:38
updated: 2021-02-06 15:39:38
tags: [前端, js]
categories: 技术
---
闭包是JavaScript中一个核心且强大的概念，理解闭包对于掌握JavaScript至关重要。
<!--more-->

# 什么是闭包？
闭包是指一个函数能够记住并访问其词法作用域，即使该函数在其词法作用域之外执行。

简单来说：当一个函数内部定义了另一个函数，并且内部函数引用了外部函数的变量，就形成了闭包。

## 闭包的形成条件
- 函数嵌套（内部函数定义在外部函数内部）
- 内部函数引用外部函数的变量 
- 内部函数在外部函数之外被调用

## 闭包的作用
- 数据封装：创建私有变量，实现信息隐藏
- 状态保持：函数执行完后，变量仍然保存在内存中
- 模块化开发：创建独立的作用域，避免全局污染

## 常见应用场景
1. 创建私有变量和方法
```javascript
// 使用闭包创建私有变量，只能通过特定方法访问。
function createBankAccount(initialBalance) {
    let balance = initialBalance;
    
    return {
        deposit: function(amount) {
            balance += amount;
        },
        withdraw: function(amount) {
            if (amount <= balance) {
                balance -= amount;
                return amount;
            }
            return 0;
        },
        getBalance: function() {
            return balance;
        }
    };
}
```
2. 实现函数柯里化
```javascript
// 将多参数函数转换为一系列单参数函数。
function multiply(a) {
    return function(b) {
        return a * b;
    };
}

const double = multiply(2);
const triple = multiply(3);

console.log(double(5)); // 10
console.log(triple(5)); // 15
```
3. 模块模式开发
```javascript
// 创建具有私有状态和公共接口的模块。
const myModule = (function() {
    let privateVar = 0;

    function privateFunction() {
        return privateVar;
    }

    return {
        publicMethod: function() {
            return privateFunction();
        },
        increment: function() {
            privateVar++;
        }
    };
})();
```
4. 事件处理程序
```javascript
// 在事件处理函数中访问外部变量。
function setupButton(buttonId, message) {
    const button = document.getElementById(buttonId);

    button.addEventListener('click', function() {
        alert(message); // 闭包保留了message的引用
    });
}
```
5. 防抖和节流函数
```javascript
// 保存定时器状态，实现性能优化。
function debounce(func, delay) {
    let timeoutId; // 闭包保存定时器ID

    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
}
```
6. 缓存函数（Memoization）
```javascript
function memoize(fn) {
    const cache = new Map();
    
    return function(...args) {
        // 创建缓存键（使用JSON.stringify简化，生产环境建议更健壮的方案）
        const key = JSON.stringify(args);
        
        if (cache.has(key)) {
            console.log('从缓存返回结果');
            return cache.get(key);
        }
        
        console.log('计算新结果');
        const result = fn.apply(this, args);
        cache.set(key, result);
        return result;
    };
}

// 使用示例 - 缓存斐波那契计算
function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

// 使用记忆化版本
const memoizedFibonacci = memoize(fibonacci);

console.log(memoizedFibonacci(10)); // 第一次计算，输出"计算新结果"
console.log(memoizedFibonacci(10)); // 第二次相同参数，输出"从缓存返回结果"
```
7. 解决循环中的异步问题
```javascript
// 问题代码
for (var i = 0; i < 5; i++) {
    setTimeout(function() {
        console.log(i); // 全部输出5
    }, 100);
}

// 解决方案
for (var i = 0; i < 5; i++) {
    (function(j) {
        setTimeout(function() {
            console.log(j); // 输出0,1,2,3,4
        }, 100);
    })(i);
}
```

## 注意事项
- 内存管理：闭包会导致变量无法被垃圾回收，可能引起内存泄漏
- 性能考虑：过度使用闭包可能影响性能
- 正确使用：在不需要时及时解除引用

## 总结
闭包是JavaScript中强大且灵活的特性，正确理解和使用闭包可以写出更加模块化、可维护性更高的代码。