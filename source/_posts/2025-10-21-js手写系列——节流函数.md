---
title: js手写系列——节流函数
date: 2025-10-21 17:36:43
tags: [js]
categories: js手写系列
---

节流是一种常用的性能优化技术，用于限制函数在特定时间间隔内只能执行一次。当频繁触发某个事件时，节流可以确保函数不会过于频繁地执行，从而提升性能。

<!--more-->

## 节流的基本概念

节流的核心思想是：**在一定时间间隔内，无论事件触发多少次，函数只会执行一次。**

与防抖(debounce)不同，防抖是在事件停止触发后延迟执行，而节流是保证在固定时间间隔内至少执行一次。

## 应用场景

- 窗口大小调整(resize)事件
- 页面滚动(scroll)事件
- 鼠标移动(mousemove)事件
- 输入框实时搜索(减少请求频率)

## 实现

1. 基础时间戳版节流
- 使用时间戳判断是否达到执行间隔
- 第一次会立即执行
- 停止触发后不会再次执行
```javascript
function throttleBasic(func, delay) {
    let lastTime = 0;
    return function (...args) {
        const currentTime = Date.now();
        if (currentTime - lastTime >= delay) {
            func.apply(this, args);
            lastTime = currentTime;
        }
    };
}
```

2. 定时器版节流
- 使用定时器延迟执行
- 第一次不会立即执行
- 停止触发后会再执行一次
```javascript
function throttleTimer(func, delay) {
    let timeoutId = null;
    return function(...args) {
        if (!timeoutId) {
            timeoutId = setTimeout(() => {
                func.apply(this, args);
                timeoutId = null;
            }, delay);
        }
    };
}
```

3. 完整版节流（结合时间戳和定时器）
- 结合时间戳和定时器
- 可配置是否立即执行（leading）和停止后是否执行（trailing)
- 功能最完整，适用性最广
```javascript
function throttle(func, delay, options = {}) {
    let timeoutId, lastTime = 0;
    const { leading = true, trailing = true } = options;
    
    return function(...args) {
        const currentTime = Date.now();
        
        // 如果是第一次调用且leading为false，设置lastTime为当前时间
        if (!lastTime && !leading) lastTime = currentTime;
        
        const remainingTime = delay - (currentTime - lastTime);
        
        if (remainingTime <= 0 || remainingTime > delay) {
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
            func.apply(this, args);
            lastTime = currentTime;
        } else if (!timeoutId && trailing) {
            timeoutId = setTimeout(() => {
                func.apply(this, args);
                lastTime = Date.now();
                timeoutId = null;
            }, remainingTime);
        }
    };
}
```

## 使用建议
- 对于需要立即响应的场景（如按钮点击），使用基础时间戳版
- 对于需要保证最后一次执行的场景，使用定时器版
- 大多数情况下，推荐使用完整版，因为它提供了最灵活的控制选项